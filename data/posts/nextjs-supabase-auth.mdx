---
title: 'User Authentication in Next.js with Supabase'
date: 'Sat Aug 07 2021 16:50:31 GMT-0400 (Eastern Daylight Time)'
summary: 'How to setup auth in your Next.js app with Supabase and Supabase UI.'
canonical: 'https://misha.wtf/blog/nextjs-supabase-auth'
tags: ['Next.js', 'Supabase', 'Supabase UI', 'Authentication']
seo:
  [
    'Vercel',
    'Next.js',
    'NextJS',
    'Supabase',
    'Supabase UI',
    'Auth',
    'Authentication',
    'OSS',
    'Open Source',
  ]
author:
  name: 'Mykhaylo Ryechkin'
  url: 'https://twitter.com/misha_wtf'
---

[Supabase](https://www.supabase.io) has been getting a lot of attention in the tech community, and for good reason. This open source platform makes it super easy to get started building complex full-stack applications, and in this post we will take a look at how to utilize one of its core offerings: **User Authentication**.

## Overview

One of the things that stands out about Supabase almost immediately is just how easy it is to get started. You can be up and running in quite literally minutes, and Authentication is no exception. It provides a fully integrated solution, including user management and email notifications, with no reliance on any external authentication services. And with Supabase being open source, you have complete control and ownership of your user data, as it's all stored in the same PostgreSQL database.

Supabase provides several different authentication mechanisms out of the box:

- Basic `Email` authentication
- `Magic Link` or a one-time login with email
- `Social` logins: Google, Facebook, GitHub, Azure, Gitlab, Twitter, Discord, and Bitbucket
- Phone / SMS login using `Twilio` integration

In this tutorial we'll be using `Email` authentication, with ability to reset forgotten password.

## Supabase Client

Supabase provides a [client library](https://supabase.io/docs/reference/javascript/supabase-client) that makes it _supa_ easy to get started in your project. It is a modular library, comprised of several different sub-libraries, each enabling integration with the specific sub-system:

- `@supabase/postgrest-js` for [PostgREST](https://github.com/postgrest/postgrest) (REST API for PostgreSQL)
- `@supabase/realtime-js` for [Realtime](https://github.com/supabase/realtime) (realtime connection to PostgreSQL via websockets)
- `@supabase/gotrue-js` for [GoTrue](https://github.com/netlify/gotrue) (fork of Netlify's authentication and user management API)

The single `@supabase/supabase-js` bundle combines the three libraries into one, and adds some ease-of-use enhancements, making it the perfect Supabase companion for your projects.

It's worthwhile to note that the client library is also available in several other different languages as well - including **C#**, **Python**, **Rust** and **Dart**.

## Supabase UI

Supabase also provides an open source component library called [Supabase UI](https://ui.supabase.io/), which is a collection of common UI components and utilities that are used across the range of Supabase products. Its styling is heavily inspired by [Tailwind CSS](https://www.tailwindcss.com/), so you know it will look good out of the box.

<PostImage src={`/blog/nextjs-supabase-auth/supabase-ui.png`} height={382} width={635} />

We will be using the [Auth](https://ui.supabase.io/components/auth) component, which provides all the necessary screens and integrations for the various authentication flows. In particular, we'll need to be able to perform the following:

- **Sign Up**
- **Sign In** (Email)
- **Sign In** (Magic Link)
- **Sign Out**
- **Forgot Password (Reset)**
- **Update Password**

As you can see, that's quite a bit of UI and state logic that we would need to implement ourselves from scratch. Using a component that provides all of that already wired up out of the box will be a big time saver.

In this tutorial, we'll take a look at everything you need to use this component in your own application, as well as some ways to customize it to your needs.

**NOTE:** At the timing of writing this post, Supabase UI is in early development stages, so the API and some features may still change in the full release. For example, theming is not currently supported, and is the reason we'll need to perform some workarounds later on.

## Supabase Setup

You will need to create a Supabase account if you haven't already done so. Supabase provides a [generous](https://supabase.io/pricing) free tier for their cloud solution, so it's easy to get started. Alternatively, since it's open-source, you can also host your own as well.

### Create Project

Once signed up and logged in to [Supabase Dashboard](https://app.supabase.io/), go ahead and create a new project. We'll name our project **ACME**.

<PostImage
  src={`/blog/nextjs-supabase-auth/create-project.png`}
  height={685}
  width={900}
/>

### API Keys

In order to be able to access the Supabase API via our JS client, we will need to have API keys available in the app.

In the dashboard, go to **Settings > API**. As you'll see, by default an anonymous public API key is already available. This will be enough for our needs. Take note of this value, as well as the `URL`:

<PostImage src={`/blog/nextjs-supabase-auth/settings.jpg`} height={650} width={900} />

Make sure to keep these on hand, as we'll need them later on.

## Project Setup

For this tutorial, we'll be using [Next.js](https://nextjs.org/) and the [TailwindCSS](https://www.tailwindcss.com/) starter template ðŸš€

To do that, run:

```bash
npx create-next-app --example with-tailwindcss next-with-supabase-auth
```

Then, install both **Supabase Client**, and **Supabase UI** dependencies:

```bash
npm install @supabase/supabase-js @supabase/ui
```

That's all we need to get started. Let's code!

## Application Structure

Our application will be pretty simple. The main `Home` page will show the different authentication screens - Sign In, Sign Up, Forgot Password, etc. It wil also show the authentication status, a button linking to a `Profile` page, and a button to sign out.

The `Profile` page will display the currently logged-in user's data, and a button to go back to `Home` page. It also needs to be a "protected" page, meaning that only authenticated users can access it. We'll take a look at how to accomplish this both on client and server-side in later steps.

First, let's scaffold out the base pages.

### Home Page

Let's go ahead and put some placeholder content on the main page to start with:

<PostImage
  src={`/blog/nextjs-supabase-auth/home-1.png`}
  alt="Image of Home page"
  height={326}
  width={1024}
/>

```jsx
// pages/index.js;
import Head from 'next/head';

export default function Home() {
  return (
    <div className="flex flex-col items-center justify-center py-2 min-h-screen">
      <Head>
        <title>Next.js with Supabase Auth</title>
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className="flex flex-1 flex-col items-center justify-center px-20 w-full text-center">
        <h1 className="text-6xl font-bold">
          Next with <span className="text-green-400 font-black">Supabase</span>
        </h1>

        <p className="mt-8 text-2xl">
          Status:
          <code className="ml-1 p-3 font-mono text-lg bg-gray-100 rounded-lg">
            Logged Out
          </code>
        </p>
      </main>
    </div>
  );
}
```

### Profile Page

Similarly, let's put some placeholder content on the Profile page:

<PostImage
  src={`/blog/nextjs-supabase-auth/profile-1.png`}
  alt="Image of Profile page"
  height={453}
  width={800}
/>

```jsx
// pages/profile.js
import Link from 'next/link';

export default function Profile() {
  return (
    <div className="flex flex-col items-center justify-center py-2 min-h-screen">
      <main className="flex flex-1 flex-col items-center justify-center px-20 w-full text-center">
        <h3 className="py-8 text-4xl font-bold">User ID</h3>
        <div className="text-gray-500 text-lg">
          <span className="mr-2 font-semibold">Last Logged In:</span>
          N/A
        </div>
        <Link href="/">
          <a className="mt-8 px-8 py-4 text-green-400 font-bold border-2 border-green-400 rounded-full">
            Go Home
          </a>
        </Link>
      </main>
    </div>
  );
}
```

## Adding Authentication

With the base of our project scaffolded out, we can start working on the authentication layer.

### Initializing Supabase

Supabase Client lets us easily work with the Supabase API, and manages our authentication and user data on the front-end. In order to initialize it, we will need to specify the URL and the public API key from the previous step.

We can do this by setting those values as [environment variables](https://nextjs.org/docs/basic-features/environment-variables) in **Next.js**. Create a `.env.local` file in the root of the project, and set the values to the ones from the dashboard earlier:

```json
NEXT_PUBLIC_SUPABASE_URL=<value>
NEXT_PUBLIC_SUPABASE_ANON_KEY=<value>
```

Next, let's create a separate file for our Supabase Client instance. Name this file `client.js` and put it in `lib` folder at the root of the project:

```jsx
// lib/client.js
import { createClient } from '@supabase/supabase-js';

export const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
);
```

Now whenever we need to use Supabase Client, we can simply import it and access the available functionality.

### Authentication Provider

In order to handle all authentication-related logic in our app, we're going to use the concept of an authenticaion provider. This pattern was heavily inspired by Kent C. Dodds [blog post](https://kentcdodds.com/blog/authentication-in-react-applications) on this topic, and follows a lot of the same basic principles.

We'll call this `AuthProvider` and use it as the top-level component in our app, thereby providing user data and authentication functionality throughout. It will utilize [React Context](https://reactjs.org/docs/context.html), and provide the `session` and `user` objects from Supabase Client, as well as the [signOut](https://supabase.io/docs/reference/javascript/auth-signout) function. The rest of the authentication flows will be handled by the `Auth` component from Supabase UI, which we'll get to in later steps.

Inside the `lib` folder, create `auth.js`, and add the following:

```jsx
// lib/auth.js
import { createContext, useContext, useEffect, useState } from 'react';

export const AuthContext = createContext();

export const AuthProvider = ({ supabase, ...props }) => {
  const [session, setSession] = useState(null);
  const [user, setUser] = useState(null);

  return (
    <AuthContext.Provider
      value={{
        session,
        user,
        signOut: () => supabase.auth.signOut(),
      }}
      {...props}
    />
  );
};

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};
```

Here, we have the main `AuthProvider`, which we'll need to wrap our application in. It provides `user` and `session` data, and the `signOut` functionality (which invokes it via Supabase Client).

We also created the `useAuth` hook to be able to easily access these values in our React components:

```jsx
import { useAuth } from '../lib/auth';

const { user, session } = useAuth();
```

Now before we can use it, we need to make `AuthProvider` the top-level wrapper of our application. We'll do this by adding the following to `pages/_app.js`:

```jsx
import { AuthProvider } from '../lib/auth';
import { supabase } from '../lib/client';

..

function MyApp({ Component, pageProps }) {
  return (
    <AuthProvider supabase={supabase}>
      <Component {...pageProps} />
    </AuthProvider>
  );
}
```

where `supabase` is our Supabase Client instance. Now we can freely use the `useAuth` hook in our app and access the `session` and `user` objects.

### Handling auth state change

We also need to add a way to update our user and session data whenever authentication status of the current user (in the Supabase Client) changes. For example, when a user successfully logs in, or logs out.

Back in our `lib/auth.js` file, let's use `useEffect` and create an `authListener` event listener for the `onAuthStateChange` event, on initial load:

```jsx
// lib/auth.js
useEffect(() => {
  const session = supabase.auth.session();
  setSession(session);
  setUser(session?.user ?? null);

  const { data: authListener } = supabase.auth.onAuthStateChange((event, session) => {
    setSession(session);
    setUser(session?.user ?? null);
  });

  return () => {
    authListener?.unsubscribe();
  };
}, []);
```

Now, whenever auth state in Supabase Client changes, our `user` and `session` state objects will get updated as well.

### Supabase UI

<PostImage src={`/blog/nextjs-supabase-auth/home-2.png`} height={1106} width={1338} />

<PostImage src={`/blog/nextjs-supabase-auth/sui-sign-up.png`} height={714} width={884} />

<PostImage
  src={`/blog/nextjs-supabase-auth/sui-password-reset.png`}
  height={388}
  width={882}
/>
