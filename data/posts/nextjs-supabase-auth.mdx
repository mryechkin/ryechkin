---
title: 'User Authentication in Next.js with Supabase'
date: 'Sat Aug 07 2021 16:50:31 GMT-0400 (Eastern Daylight Time)'
summary: 'How to setup auth in your Next.js app with Supabase and Supabase UI.'
canonical: 'https://misha.wtf/blog/nextjs-supabase-auth'
tags: ['Next.js', 'Supabase', 'Supabase UI', 'Authentication']
seo:
  [
    'Vercel',
    'Next.js',
    'NextJS',
    'Supabase',
    'Supabase UI',
    'Auth',
    'Authentication',
    'OSS',
    'Open Source',
  ]
author:
  name: 'Mykhaylo Ryechkin'
  url: 'https://twitter.com/misha_wtf'
---

[Supabase](https://www.supabase.io) has been getting a lot of attention in the tech community, and for good reason. This open source platform makes it super easy to get started building complex full-stack applications, and in this post we will take a look at how to utilize one of its core offerings: **User Authentication**.

## Overview

One of the things that stands out about Supabase almost immediately is just how easy it is to get started. You can be up and running in quite literally minutes, and Authentication is no exception. It provides a fully integrated solution, including user management and email notifications, with no reliance on any external authentication services. And with Supabase being open source, you have complete control and ownership of your user data, as it's all stored in the same PostgreSQL database.

Supabase provides several different authentication mechanisms out of the box:

- Basic **Email** authentication
- **Magic Link** or a one-time login with email
- **Social** logins: Google, Facebook, GitHub, Azure, Gitlab, Twitter, Discord, and Bitbucket
- Phone / SMS login using **Twilio** integration

In this tutorial we'll be using **Email** authentication, with ability to reset forgotten password.

## Supabase Client

Supabase provides a [client library](https://supabase.io/docs/reference/javascript/supabase-client) that makes it _supa easy_ to get started in your project. It is a modular library, comprised of several different sub-libraries, each enabling integration with the specific sub-system:

- **@supabase/postgrest-js** for [PostgREST](https://github.com/postgrest/postgrest) (REST API for PostgreSQL)
- **@supabase/realtime-js** for [Realtime](https://github.com/supabase/realtime) (realtime connection to PostgreSQL via websockets)
- **@supabase/gotrue-js** for [GoTrue](https://github.com/netlify/gotrue) (fork of Netlify's authentication and user management API)

The single `@supabase/supabase-js` bundle combines the three libraries into one, and adds some ease-of-use enhancements, making it the perfect Supabase companion for your projects.

It's worthwhile to note that the client library is also available in several other different languages as well - including **C#**, **Python**, **Rust** and **Dart**.

## Supabase UI

Supabase also provides an open source component library called [Supabase UI](https://ui.supabase.io/), which is a collection of common UI components and utilities that are used across the range of Supabase products. Its styling is heavily inspired by [Tailwind CSS](https://www.tailwindcss.com/), so you know it will look good out of the box.

<PostImage src={`/blog/nextjs-supabase-auth/supabase-ui.png`} alt="Supabase UI" height={382} width={635} />
<Caption>Supabase UI</Caption>

We will be using the [Auth](https://ui.supabase.io/components/auth) component, which provides all the necessary screens and integrations for the various authentication flows. In particular, we'll need to be able to perform the following:

- **Sign Up** (Email)
- **Sign In** (Email)
- **Sign Out**
- **Reset Password**
- **Update Password**

As you can see, that's quite a bit of UI and state logic that we would need to implement ourselves from scratch. Using a component that provides all of that already wired up out of the box will be a big time saver.

In this tutorial, we'll take a look at everything you need to use this component in your own application, as well as some ways to customize it to your needs.

**NOTE:** At the timing of writing this post, Supabase UI is in early development stages, so the API and some features may still change in the full release. For example, theming is not currently supported, and is the reason we'll need to perform some workarounds later on.

## Supabase Setup

You will need to create a Supabase account if you haven't already done so. Supabase provides a [generous](https://supabase.io/pricing) free tier for their cloud solution, so it's easy to get started. Alternatively, since it's open-source, you can also host your own as well.

### Create Project

Once signed up and logged in to [Supabase Dashboard](https://app.supabase.io/), go ahead and create a new project. We'll name our project **ACME**.

<PostImage
  src={`/blog/nextjs-supabase-auth/create-project.png`}
  alt="Create a project in Supabase Dashboard"
  height={685}
  width={900}
/>
<Caption>Create a project in Supabase Dashboard</Caption>

### API Keys

In order to be able to access the Supabase API via our JS client, we will need to have API keys available in the app.

In the dashboard, go to **Settings > API**. As you'll see, by default an anonymous public API key is already available. This will be enough for our needs. Take note of this value, as well as the `URL`:

<PostImage src={`/blog/nextjs-supabase-auth/settings.jpg`} alt="API Settings in Supabase Dashboard" height={650} width={900} />
<Caption>API Settings in Supabase Dashboard</Caption>

Make sure to keep these on hand, as we'll need them later on.

## Project Setup

For this tutorial, we'll be using [Next.js](https://nextjs.org/) and the [TailwindCSS](https://www.tailwindcss.com/) starter template ðŸš€

To do that, run:

```bash
npx create-next-app --example with-tailwindcss next-with-supabase-auth
```

Then, install both **Supabase Client**, and **Supabase UI** dependencies:

```bash
npm install @supabase/supabase-js @supabase/ui
```

That's all we need to get started. Let's code!

## Application Structure

Our application will be pretty simple. The main `Home` page will show the different authentication screens - Sign In, Sign Up, Forgot Password, etc. It wil also show the authentication status, a button linking to a `Profile` page, and a button to sign out.

The `Profile` page will display the currently logged-in user's data, and a button to go back to `Home` page. It also needs to be a "protected" page, meaning that only authenticated users can access it. We'll take a look at how to accomplish this both on client and server-side in later steps.

First, let's scaffold out the base pages.

### Home Page

Let's go ahead and put some placeholder content on the main page to start with:

<PostImage
  src={`/blog/nextjs-supabase-auth/home-1.png`}
  alt="Home Page (placeholder)"
  width={720}
  height={218}
/>
<Caption>pages/index.js</Caption>

```jsx
// pages/index.js;
import Layout from '@/components/Layout';

export default function Home() {
  return (
    <Layout>
      <p className="my-4 text-lg">
        Status:
        <code className="highlight">Logged Out</code>
      </p>
    </Layout>
  );
}
```

### Profile Page

Similarly, let's put some placeholder content on the Profile page:

<PostImage
  src={`/blog/nextjs-supabase-auth/profile-1.png`}
  alt="Profile Page (placeholder)"
  width={714}
  height={408}
/>
<Caption>pages/profile.js</Caption>

```jsx
// pages/profile.js
import Link from 'next/link';

import Layout from '@/components/Layout';

export default function Profile() {
  return (
    <Layout>
      <h3 className="py-8 text-4xl font-black">User ID</h3>
      <p className="my-4 text-lg">
        Last Signed In:
        <code className="highlight">N/A</code>
      </p>
      <div className="inline-flex flex-col">
        <Link href="/">
          <a className="button mt-8">Go Home</a>
        </Link>
      </div>
    </Layout>
  );
}
```

Where `Layout` is a layout container, abstracted into a component in `components/Layout.js`:

```jsx
// components/Layout.js
import Head from 'next/head';

export default function Layout({ children }) {
  return (
    <div className="flex flex-col items-center justify-center py-2 min-h-screen">
      <Head>
        <title>Next.js with Supabase Auth</title>
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className="flex flex-1 flex-col items-center justify-center px-8 w-full text-center sm:px-20">
        <h1 className="text-5xl font-bold sm:text-6xl">
          Next.js with <span className="text-green-400 font-black">Supabase</span>
        </h1>
        <div className="mt-8 w-full max-w-sm">{children}</div>
      </main>
    </div>
  );
}
```

We've also abstracted some CSS classes that will be used throughout the app in the `styles/globals.css` file (via Tailwind classes):

```css
/* styles/globals.css */
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  .button {
    @apply px-8 py-2 text-green-400 hover:text-white focus:text-white font-bold focus:bg-green-400 hover:bg-green-400 border-2 border-green-400 rounded-full;
  }
  .highlight {
    @apply ml-1 p-2 font-mono bg-gray-100 rounded-lg;
  }
}
```

## Adding Authentication

With the base of our project scaffolded out, we can start working on the authentication layer.

### Initializing Supabase

Supabase Client lets us easily work with the Supabase API, and manages our authentication and user data on the front-end. In order to initialize it, we will need to specify the URL and the public API key from the previous step.

We can do this by setting those values as [environment variables](https://nextjs.org/docs/basic-features/environment-variables) in **Next.js**. Create a `.env.local` file in the root of the project, and set the values to the ones from the dashboard earlier:

```json
// .env.local
NEXT_PUBLIC_SUPABASE_URL=<value>
NEXT_PUBLIC_SUPABASE_ANON_KEY=<value>
```

Next, let's create a separate file for our Supabase Client instance. Name this file `client.js` and put it in `lib` folder at the root of the project:

```jsx
// lib/client.js
import { createClient } from '@supabase/supabase-js';

export const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
);
```

Now whenever we need to use Supabase Client, we can simply import it and access the available functionality.

### Authentication Provider

In order to handle all the authentication logic in our app, we're going to use the concept of an authenticaion provider. This pattern was heavily inspired by Kent C. Dodds [blog post](https://kentcdodds.com/blog/authentication-in-react-applications) on this topic, and follows a lot of the same basic principles.

We'll call this `AuthProvider` and use it as the top-level component in our app, thereby providing user data and authentication functionality throughout. It will utilize [React Context](https://reactjs.org/docs/context.html), and provide the `session` and `user` objects from Supabase Client, as well as the [signOut](https://supabase.io/docs/reference/javascript/auth-signout) function. The rest of the authentication flows will be handled by the `Auth` component from Supabase UI, which we'll get to in later steps.

Inside the `lib` folder, create a file `auth.js`, and add the following:

```jsx
// lib/auth.js
import { createContext, useContext, useEffect, useState } from 'react';

export const AuthContext = createContext();

export const AuthProvider = ({ supabase, ...props }) => {
  const [session, setSession] = useState(null);
  const [user, setUser] = useState(null);

  return (
    <AuthContext.Provider
      value={{
        session,
        user,
        signOut: () => supabase.auth.signOut(),
      }}
      {...props}
    />
  );
};

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};
```

Here, we have the main `AuthProvider`, which we'll need to wrap our application in. It provides the `user` and `session` values, as well as exposes the `signOut` function from Supabase Client. To access these values in our app pages, we've also created the `useAuth` hook, which simply pulls the values from the `AuthContext`.

Now before we can use it, we need to make `AuthProvider` the top-level component of our application. We'll do this by adding the following to `pages/_app.js`:

```jsx
// pages/_app.js
import { AuthProvider } from '@/lib/auth';
import { supabase } from '@/lib/client';

// ...

function MyApp({ Component, pageProps }) {
  return (
    <AuthProvider supabase={supabase}>
      <Component {...pageProps} />
    </AuthProvider>
  );
}
```

Where `supabase` is our Supabase Client instance. Now we can freely use the `useAuth` hook in our app and access the `session` and `user` objects.

Here is how you could check for the currently logged-in `user` on the Home page and display the corresponding status (ie. `Logged In` / `Logged Out`). We can also add a button to log out the current user, by calling the `signOut` function:

```jsx
// pages/index.js
import { useAuth } from '@/lib/auth';

export default function Home() {
  const { user, signOut } = useAuth();

  // ...

  return (
    // ...

    <p className="my-4 text-lg">
      Status:
      <code className="highlight">{user ? 'Logged In' : 'Logged Out'}</code>
    </p>

    {user && (
      <div className="inline-flex flex-col mt-8 space-y-8">
        <Link href="/profile">
          <a className="button">Go to Profile</a>
        </Link>
        <button type="button" className="button" onClick={signOut}>
          Sign Out
        </button>
      </div>
    )}

    // ...
  );
}
```

<p className="text-base">
  <span className="accent font-bold sm:ml-4">â†’ TIP:</span> Enable{' '}
  <ExternalLink href="https://nextjs.org/docs/advanced-features/module-path-aliases">
    absolute import paths and module aliases
  </ExternalLink>{' '}
  in Next.js for shorter imports.
</p>


## Adding Supabase UI

We're getting closer to having our authentication flows working, however we're still missing a critical piece of the solution - the UI itself! As we saw earlier, we will need to be able to do the following: **Sign Up**, **Sign In**, **Sign Out**, **Reset Password**, **Update Password**.

Normally this would take quite a bit of time to build ourselves from scratch - we'd need to create several different forms, add input validation, error handling, state and UI logic, and so on. As you can see, the list gets rather long, rather quickly.

Luckily, Supabase makes this easy for us to do as well. Using the Auth component from **Supabase UI**, we can add all of these required screens to our app with fairly minimal effort, and it'll have the mentioned functionality already baked-in.

To do this, we'll add the `Auth` component to our main landing page, and pass it our Supabase Client instance. In `pages/index.js`, add:

```jsx
// pages/index.js
import { Auth } from '@supabase/ui';

import { supabase } from '@/lib/client';

// ...

return (
  // ...
  {!user && <Auth supabaseClient={supabase} />}
  // ...
);
```

<PostImage
  src={`/blog/nextjs-supabase-auth/home-2.png`}
  alt="Sign In"
  width={714}
  height={570}
/>
<Caption>Sign In</Caption>

We pass our `supabase` client instance to it via the `supabaseClient` prop, and _voila!_ ðŸŽ‰ Now we have a shiny new UI, with all of the required forms to handle the login flows. Before we can fully test this, however, there are still a few things we need to setup.

## Handling Auth State Change

What happens if the authenticated state changes in Supabase Client? For example, when a user successfully logs in, or the current user signs out? Our application will need to know about these changes in the state. So, we also need a way to update our `user` and `session` data whenever this happens. We can do this by adding an event listener on the `onAuthStateChange` method in Supabase Client.

Back in our `lib/auth.js` file, create `authListener` for the `onAuthStateChange` event inside a `useEffect` hook (on initial load):

```jsx
// lib/auth.js

// ...

useEffect(() => {
  const activeSession = supabase.auth.session();
  setSession(activeSession);
  setUser(activeSession?.user ?? null);

  const { data: authListener } = supabase.auth.onAuthStateChange(
    (event, currentSession) => {
      setSession(currentSession);
      setUser(currentSession?.user ?? null);
    }
  );

  return () => {
    authListener?.unsubscribe();
  };
}, []);

// ...
```

Now whenever auth state in Supabase Client changes, our `user` and `session` state objects will be updated as well, and this data will be in sync with Supabase Client.

Next, we need a way to tell the `Auth` component which screen to show as a result of the auth state change. For example, when a user signs out, we want our `Auth` component to show the **Sign In** screen again. We can do this by passing `view` prop to the `Auth` component, which tells it what authentication flow to show. The `event` received by `onAuthStateChanged` will dictate which view we should be showing. We'll see how this gets utilized for updating a user's password, in the later step.

First, let's store all the possible values for both the `VIEWS` and `EVENTS` in `lib/auth.js`:

```jsx
// lib/auth.js

// ...

export const EVENTS = {
  PASSWORD_RECOVERY: 'PASSWORD_RECOVERY',
  SIGNED_OUT: 'SIGNED_OUT',
  USER_UPDATED: 'USER_UPDATED',
};

export const VIEWS = {
  SIGN_IN: 'sign_in',
  SIGN_UP: 'sign_up',
  FORGOTTEN_PASSWORD: 'forgotten_password',
  MAGIC_LINK: 'magic_link',
  UPDATE_PASSWORD: 'update_password',
};

// ...
```

Then, we'll need to keep track of the current view in our `AuthProvider`, so let's add it as `view` to the context as well:

```jsx
// lib/auth.js
export const AuthProvider = ({ supabase, ...props }) => {
  const [view, setView] = useState(VIEWS.SIGN_IN);

  // ...

  useEffect(() => {
    // ...

    const { data: authListener } = supabase.auth.onAuthStateChange(
      (event, currentSession) => {
        setSession(currentSession);
        setUser(currentSession?.user ?? null);

        switch (event) {
          case EVENTS.PASSWORD_RECOVERY:
            setView(VIEWS.UPDATE_PASSWORD);
            break;
          case EVENTS.SIGNED_OUT:
          case EVENTS.USER_UPDATED:
            setView(VIEWS.SIGN_IN);
            break;
          default:
        }
      }
    );

    // ...
  }, []);

  return (
    <AuthContext.Provider
      value={{
        session,
        user,
        view,
        signOut: () => supabase.auth.signOut(),
      }}
      {...props}
    />
  );
};
```

Here, we're setting the `view` to `UPDATE_PASSWORD` when `PASSWORD_RECOVERY` event is dispatched, and to `SIGN_IN` when user logs out, or user is updated in session. Now all that's left is to pass this value to `Auth` component. In our Home page `pages/index.js`, update the following:

```jsx
// pages/index.js
export default function Home() {
  const { user, view, signOut } = useAuth();
  // ...
  return (
    // ...
    {!user && <Auth view={view} supabaseClient={supabase} />}
    // ...
  );
}
```

## Authentication Flows

Now that we have our UI and `AuthProvider` setup, let's go through the available authentication flows, and see them in action.

### Sign Up

First, we'll need to create a new user.

<PostImage
  src={`/blog/nextjs-supabase-auth/sui-sign-up.png`}
  alt="Sign Up"
  width={884}
  height={714}
/>
<Caption>Sign Up</Caption>

### Password Reset

<PostImage
  src={`/blog/nextjs-supabase-auth/sui-password-reset.png`}
  alt="Password Reset"
  width={882}
  height={388}
/>
<Caption>Password Reset</Caption>

<PostImage
  src={`/blog/nextjs-supabase-auth/reset-password-email.png`}
  alt="Reset Password - default email"
  width={694}
  height={490}
/>
<Caption>Reset Password - default email</Caption>
